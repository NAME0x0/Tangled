<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entangled - Inspired by Bjørn Ståål</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            z-index: 100;
            max-width: 350px;
        }
        
        #container {
            width: 100%;
            height: 100%;
            position: absolute;
        }
        
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            font-family: monospace;
            z-index: 100;
            display: none; /* Hidden by default */
            max-height: 300px;
            overflow-y: auto;
        }
        
        .instructions {
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.4;
            color: #ccc;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.5s ease-out;
        }
        
        .instructions.visible {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        
        .toggle-link {
            color: #aaa;
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-top: 8px;
        }
        
        .toggle-link:hover {
            color: #fff;
            text-decoration: underline;
        }
        
        .instructions p {
            margin: 8px 0;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin: 8px 0;
        }
        
        .instructions li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="info">
        <h2>Entangled</h2>
        <p>Inspired by Bjørn Ståål</p>
        <p>Move your mouse to interact with the orb.</p>
        <button id="newWindow" class="button">Open New Window</button>
        <a href="#" id="toggleDebug" style="margin-left: 10px; color: #aaa; font-size: 12px;">Show Debug</a>
        <a href="#" id="toggleInstructions" class="toggle-link">How It Works ▼</a>
        
        <div class="instructions" id="instructions">
            <p><strong>Quick Guide:</strong></p>
            <ol>
                <li>Click "Open New Window" to create a new window</li>
                <li>Position the new window anywhere on your screen</li>
                <li>A tether will form connecting both windows</li>
                <li>Each window shows one orb with colors indicating its generation</li>
                <li>Watch particles flow between orbs along the tethers</li>
                <li>Press Space to toggle tether visibility</li>
            </ol>
            <p>Windows will detect each other's positions and form tethers pointing in the correct direction. Each window maintains connections to both its parent and any children.</p>
            <p>Particles orbit around orbs like tiny satellites and occasionally travel along tethers to other orbs, creating a visual data exchange between windows.</p>
            <p>The tether's orientation reflects the actual physical position of the windows on your screen in 360 degrees.</p>
        </div>
    </div>
    
    <div id="debug">
        <strong>Debug Info:</strong>
        <div id="debugInfo">Waiting for initialization...</div>
    </div>
    
    <!-- Load Three.js and simplex noise -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simplex-noise@2.4.0/simplex-noise.min.js"></script>
    
    <!-- Inline script to handle debug and new window functionalities -->
    <script>
        // Show debug information
        function updateDebug(message) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `<br>${timestamp}: ${message}`;
                // Scroll to bottom
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        // Toggle debug panel
        document.getElementById('toggleDebug').addEventListener('click', function(e) {
            e.preventDefault();
            const debugPanel = document.getElementById('debug');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
                this.textContent = 'Hide Debug';
            } else {
                debugPanel.style.display = 'none';
                this.textContent = 'Show Debug';
            }
        });
        
        // Toggle instructions panel
        document.getElementById('toggleInstructions').addEventListener('click', function(e) {
            e.preventDefault();
            const instructions = document.getElementById('instructions');
            instructions.classList.toggle('visible');
            this.textContent = instructions.classList.contains('visible') ? 
                'How It Works ▲' : 'How It Works ▼';
        });
        
        // Listen for storage events to detect cross-window updates
        window.addEventListener('storage', function(e) {
            if (e.key === 'entangledWindows') {
                updateDebug('Detected window state change');
                if (typeof checkWindowPosition === 'function') {
                    checkWindowPosition();
                }
            }
        });
        
        // Open new window button
        document.getElementById('newWindow').addEventListener('click', function() {
            updateDebug("Opening new window...");
            try {
                const url = window.location.href.split('?')[0]; // Remove any query params
                const newWindow = window.open(url, '_blank');
                
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    updateDebug("Popup blocked!");
                    alert('Popup blocked! Please allow popups for this website to open a new window.');
                } else {
                    updateDebug("New window opened successfully");
                    
                    // Suggest to user to position the window
                    const positionMessage = "For the best experience, position the new window anywhere on your screen to see the tether form between windows.";
                    updateDebug(positionMessage);
                }
            } catch (error) {
                updateDebug(`Error opening window: ${error.message}`);
                alert('Error opening new window: ' + error.message);
            }
        });
        
        // Check if required scripts loaded
        window.addEventListener('load', function() {
            updateDebug('Page loaded, checking resources...');
            if (typeof THREE === 'undefined') {
                updateDebug('THREE.js not loaded!');
                alert('Error: THREE.js failed to load. Please check your internet connection and try refreshing the page.');
            } else {
                updateDebug('THREE.js loaded successfully');
            }
            
            if (typeof SimplexNoise === 'undefined') {
                updateDebug('WARNING: SimplexNoise not loaded, using fallback');
            } else {
                updateDebug('SimplexNoise loaded successfully');
            }
        });
    </script>
    
    <!-- Load our main script -->
    <script src="/static/js/entangled.js"></script>
</body>
</html>